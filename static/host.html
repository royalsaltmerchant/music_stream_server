<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FRC Radio ‚Äì Host Control</title>
    <link rel="stylesheet" href="static/style.css" />
  </head>
  <body>
    <h1>FRC Radio ‚Äì Host Control Panel</h1>

    <!-- <p><strong>Managing Channel:</strong> <span id="channel-name"></span></p> -->
    <p>
      <strong>Listener Link:</strong>
      <input
        id="listener-link"
        type="text"
        readonly
        style="width: 100%; max-width: 400px"
      />
    </p>
    <br>
    <button style="height: 40px;" onclick="copyListenerLink()">üìã Copy Link</button>
    <br>
    <!-- <br>
    <h3>Commands</h3>
    <div>
      <button onclick="sendCommand('next')">‚è≠Ô∏è Next Track</button>
    </div> -->

    <br />
    <h4>Select Music:</h4>
    <label for="category-select">Category:</label>
    <select id="category-select">
      <option disabled selected>Select Category</option>
    </select>
    <br />
    <label for="playlist-select">Playlist:</label>
    <select id="playlist-select" disabled>
      <option disabled selected>Select Playlist</option>
    </select>
    <br />
    <button onclick="changePlaylist()">üéµ Start Playlist</button>

    <p id="status" style="margin-top: 20px; color: var(--green)"></p>

    <script>
      const statusEl = document.getElementById("status");
      const playlistSelect = document.getElementById("playlist-select");
      let categoriesData = {};

      const urlParams = new URLSearchParams(window.location.search);
      const CHANNEL = urlParams.get("channel");
      // document.getElementById("channel-name").textContent = CHANNEL || "(none)";

      if (!CHANNEL) {
        alert(
          "Missing channel name in URL. Please use ?channel=<channel name>"
        );
      }

      if (CHANNEL) {
        const link = `${
          window.location.origin
        }/listen?channel=${encodeURIComponent(CHANNEL)}`;
        document.getElementById("listener-link").value = link;
      }

      function copyListenerLink() {
        const input = document.getElementById("listener-link");
        input.select();
        input.setSelectionRange(0, 99999); // For mobile
        document.execCommand("copy");
        statusEl.textContent = "üìã Link copied to clipboard.";
      }

      async function fetchPlaylists() {
        try {
          const res = await fetch("/playlists");
          const data = await res.json();

          categoriesData = data.categories;

          const categorySelect = document.getElementById("category-select");
          categorySelect.innerHTML = "<option disabled selected>Select Category</option>";

          Object.keys(categoriesData).sort().forEach((category) => {
            const option = document.createElement("option");
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
          });

          // Add change handler
          categorySelect.addEventListener("change", onCategoryChange);
        } catch (err) {
          statusEl.textContent = "‚ùå Failed to fetch playlists.";
          console.error(err);
        }
      }

      function onCategoryChange() {
        const categorySelect = document.getElementById("category-select");
        const playlistSelect = document.getElementById("playlist-select");
        const selectedCategory = categorySelect.value;

        if (!selectedCategory) {
          playlistSelect.disabled = true;
          playlistSelect.innerHTML = "<option disabled selected>Select Playlist</option>";
          return;
        }

        const playlists = categoriesData[selectedCategory] || [];
        playlistSelect.innerHTML = "<option disabled selected>Select Playlist</option>";
        playlists.forEach((pl) => {
          const option = document.createElement("option");
          option.value = pl;
          option.textContent = pl;
          playlistSelect.appendChild(option);
        });

        playlistSelect.disabled = false;
      }

      async function sendCommand(cmd) {
        if (!CHANNEL) return;

        try {
          const res = await fetch("/command", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ channel: CHANNEL, command: cmd }),
          });

          const data = await res.json();
          if (res.ok) {
            statusEl.textContent = `‚úÖ Sent command: ${data.channel} ‚Üí ${cmd}`;
          } else {
            statusEl.textContent = `‚ùå Error: ${data.error}`;
          }
        } catch (err) {
          statusEl.textContent = "‚ùå Command failed.";
          console.error(err);
        }
      }

      async function changePlaylist() {
        if (!CHANNEL) return;

        const categorySelect = document.getElementById("category-select");
        const playlistSelect = document.getElementById("playlist-select");
        const category = categorySelect.value;
        const playlist = playlistSelect.value;

        if (!category || !playlist) {
          statusEl.textContent = "‚ùå No category or playlist selected.";
          return;
        }

        const fullPlaylist = `${category}/${playlist}`;

        try {
          const res = await fetch("/command", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              channel: CHANNEL,
              playlist: fullPlaylist,
            }),
          });

          const data = await res.json();
          if (res.ok) {
            statusEl.textContent = `‚úÖ Channel "${data.channel}" now playing "${category}/${playlist}"`;
          } else {
            statusEl.textContent = `‚ùå ${data.error}`;
          }
        } catch (err) {
          statusEl.textContent = "‚ùå Playlist change failed.";
          console.error(err);
        }
      }

      fetchPlaylists();
    </script>
  </body>
</html>
